<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: QiniuNg::Storage::Model::UploadPolicy
  
    &mdash; Documentation by YARD 0.9.20
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "QiniuNg::Storage::Model::UploadPolicy";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../_index.html">Index (U)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../QiniuNg.html" title="QiniuNg (module)">QiniuNg</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Storage.html" title="QiniuNg::Storage (module)">Storage</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span>
     &raquo; 
    <span class="title">UploadPolicy</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: QiniuNg::Storage::Model::UploadPolicy
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">QiniuNg::Storage::Model::UploadPolicy</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/qiniu_ng/storage/model/upload_policy.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>七牛上传策略</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy">https://developer.qiniu.com/kodo/manual/1206/put-policy</a></li>
    
  </ul>

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span>
    
  
    
  
</p>




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#bucket-instance_method" title="#bucket (instance method)">#<strong>bucket</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>存储空间名称.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#callback_body-instance_method" title="#callback_body (instance method)">#<strong>callback_body</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后的回调请求的内容。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#callback_body_type-instance_method" title="#callback_body_type (instance method)">#<strong>callback_body_type</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后的回调请求的内容类型，默认为 application/x-www-form-urlencoded。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body-type">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#callback_host-instance_method" title="#callback_host (instance method)">#<strong>callback_host</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后的回调 HOST。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-host">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#callback_urls-instance_method" title="#callback_urls (instance method)">#<strong>callback_urls</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后，将回调业务服务器的 URL 列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#end_user-instance_method" title="#end_user (instance method)">#<strong>end_user</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>唯一属主标识 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-end-user">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#force_save_key-instance_method" title="#force_save_key (instance method)">#<strong>force_save_key</strong>  &#x21d2; Boolean </a>
    

    
      (also: #force_save_key?)
    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Save_key 优先级设置.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#key-instance_method" title="#key (instance method)">#<strong>key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>文件名或文件名前缀.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#max_file_size-instance_method" title="#max_file_size (instance method)">#<strong>max_file_size</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>限定上传文件大小最大值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#fsize-limit">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#min_file_size-instance_method" title="#min_file_size (instance method)">#<strong>min_file_size</strong>  &#x21d2; Integer </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>限定上传文件大小最小值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#persistent_notify_url-instance_method" title="#persistent_notify_url (instance method)">#<strong>persistent_notify_url</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>接收持久化处理结果通知的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#putpolicy-persistentNotifyUrl">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#persistent_ops-instance_method" title="#persistent_ops (instance method)">#<strong>persistent_ops</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后触发执行的预转持久化处理指令列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#persistent_pipeline-instance_method" title="#persistent_pipeline (instance method)">#<strong>persistent_pipeline</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>转码队列名。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistentPipeline">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#return_body-instance_method" title="#return_body (instance method)">#<strong>return_body</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>文件名或文件名前缀，上传成功后，自定义七牛云最终返回给上传端的数据。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-body">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#return_url-instance_method" title="#return_url (instance method)">#<strong>return_url</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Web 端文件上传成功后，浏览器执行 303 跳转的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#save_key-instance_method" title="#save_key (instance method)">#<strong>save_key</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>自定义文件名，force_save_key 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 save_key， 而当 force_save_key 为 true 时，将强制将文件命名为 save_key。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key">参考文档</a>.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#scope-instance_method" title="#scope (instance method)">#<strong>scope</strong>  &#x21d2; String </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传目标范围.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#content_type_limit-instance_method" title="#content_type_limit (instance method)">#<strong>content_type_limit</strong>  &#x21d2; Array&lt;String&gt; </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>获取上传文件的 MIME 类型限定范围.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#detect_mime!-instance_method" title="#detect_mime! (instance method)">#<strong>detect_mime!</strong>  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#detect_mime%3F-instance_method" title="#detect_mime? (instance method)">#<strong>detect_mime?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>是否自动侦测上传文件的 MIME 类型？ 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#file_lifetime-instance_method" title="#file_lifetime (instance method)">#<strong>file_lifetime</strong>  &#x21d2; QiniuNg::Duration </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>获取上传文件的生命周期.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#infrequent_storage!-instance_method" title="#infrequent_storage! (instance method)">#<strong>infrequent_storage!</strong>  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>使用低频存储.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#infrequent_storage%3F-instance_method" title="#infrequent_storage? (instance method)">#<strong>infrequent_storage?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>是否使用低频存储.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#insert_only!-instance_method" title="#insert_only! (instance method)">#<strong>insert_only!</strong>  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>仅能以新增模式上传文件.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#insert_only%3F-instance_method" title="#insert_only? (instance method)">#<strong>insert_only?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>是否仅能以新增模式上传文件.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#limit_content_type-instance_method" title="#limit_content_type (instance method)">#<strong>limit_content_type</strong>(content_type)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>限定上传文件的 MIME 类型范围.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#limit_file_size-instance_method" title="#limit_file_size (instance method)">#<strong>limit_file_size</strong>(max: nil, min: nil)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>限定上传文件的大小范围.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#normal_storage!-instance_method" title="#normal_storage! (instance method)">#<strong>normal_storage!</strong>  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>使用标准存储.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#normal_storage%3F-instance_method" title="#normal_storage? (instance method)">#<strong>normal_storage?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>是否使用标准存储.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#prefixal_scope%3F-instance_method" title="#prefixal_scope? (instance method)">#<strong>prefixal_scope?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>判断 #key 表示的是文件名前缀还是文件名.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#save_as-instance_method" title="#save_as (instance method)">#<strong>save_as</strong>(key, force: false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传文件的文件名.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_callback-instance_method" title="#set_callback (instance method)">#<strong>set_callback</strong>(urls, host: nil, body: nil, body_type: nil)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后，将回调业务服务器。.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_file_lifetime-instance_method" title="#set_file_lifetime (instance method)">#<strong>set_file_lifetime</strong>(days:)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传文件的生命周期.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_persistent_ops-instance_method" title="#set_persistent_ops (instance method)">#<strong>set_persistent_ops</strong>(ops, notify_url: nil, pipeline: nil)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传成功后触发执行的预转持久化处理.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_return-instance_method" title="#set_return (instance method)">#<strong>set_return</strong>(url: nil, body: nil)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>要求 Web 端文件上传成功后，浏览器执行 303 跳转.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_token_lifetime-instance_method" title="#set_token_lifetime (instance method)">#<strong>set_token_lifetime</strong>(*args)  &#x21d2; QiniuNg::Storage::Model::UploadPolicy </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传凭证有效期.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#token_deadline-instance_method" title="#token_deadline (instance method)">#<strong>token_deadline</strong>  &#x21d2; Time </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传凭证过期时间.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#token_deadline=-instance_method" title="#token_deadline= (instance method)">#<strong>token_deadline=</strong>(deadline)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传凭证过期时间.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#token_lifetime-instance_method" title="#token_lifetime (instance method)">#<strong>token_lifetime</strong>  &#x21d2; QiniuNg::Duration<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>上传凭证有效期.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#token_lifetime=-instance_method" title="#token_lifetime= (instance method)">#<strong>token_lifetime=</strong>(lifetime)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>设置上传凭证有效期.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="bucket-instance_method">
  
    #<strong>bucket</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 存储空间名称</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>存储空间名称</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="callback_body-instance_method">
  
    #<strong>callback_body</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传成功后的回调请求的内容。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后的回调请求的内容。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="callback_body_type-instance_method">
  
    #<strong>callback_body_type</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传成功后的回调请求的内容类型，默认为 application/x-www-form-urlencoded。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body-type">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后的回调请求的内容类型，默认为 application/x-www-form-urlencoded。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-body-type">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="callback_host-instance_method">
  
    #<strong>callback_host</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传成功后的回调 HOST。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-host">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后的回调 HOST。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-host">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="callback_urls-instance_method">
  
    #<strong>callback_urls</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传成功后，将回调业务服务器的 URL 列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后，将回调业务服务器的 URL 列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="end_user=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="end_user-instance_method">
  
    #<strong>end_user</strong>  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 唯一属主标识 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-end-user">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>唯一属主标识 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-end-user">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="force_save_key-instance_method">
  
    #<strong>force_save_key</strong>  &#x21d2; <tt>Boolean</tt>  <span class="extras">(readonly)</span>
  

  
    <span class="aliases">Also known as:
    <span class="names"><span id='force_save_key?-instance_method'>force_save_key?</span></span>
    </span>
  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns save_key 优先级设置</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>save_key 优先级设置</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="key-instance_method">
  
    #<strong>key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 文件名或文件名前缀</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>文件名或文件名前缀</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="max_file_size-instance_method">
  
    #<strong>max_file_size</strong>  &#x21d2; <tt>Integer</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 限定上传文件大小最大值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#fsize-limit">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限定上传文件大小最大值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#fsize-limit">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="min_file_size-instance_method">
  
    #<strong>min_file_size</strong>  &#x21d2; <tt>Integer</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 限定上传文件大小最小值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限定上传文件大小最小值，单位为字节 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="persistent_notify_url-instance_method">
  
    #<strong>persistent_notify_url</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 接收持久化处理结果通知的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#putpolicy-persistentNotifyUrl">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>接收持久化处理结果通知的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#putpolicy-persistentNotifyUrl">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="persistent_ops-instance_method">
  
    #<strong>persistent_ops</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传成功后触发执行的预转持久化处理指令列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后触发执行的预转持久化处理指令列表。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="persistent_pipeline-instance_method">
  
    #<strong>persistent_pipeline</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 转码队列名。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistentPipeline">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>转码队列名。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistentPipeline">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="return_body-instance_method">
  
    #<strong>return_body</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 文件名或文件名前缀，上传成功后，自定义七牛云最终返回给上传端的数据。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-body">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>文件名或文件名前缀，上传成功后，自定义七牛云最终返回给上传端的数据。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-body">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="return_url-instance_method">
  
    #<strong>return_url</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns Web 端文件上传成功后，浏览器执行 303 跳转的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Web 端文件上传成功后，浏览器执行 303 跳转的 URL。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="save_key-instance_method">
  
    #<strong>save_key</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 自定义文件名，force_save_key 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 save_key， 而当 force_save_key 为 true 时，将强制将文件命名为 save_key。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key">参考文档</a></p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>自定义文件名，force_save_key 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 save_key， 而当 force_save_key 为 true 时，将强制将文件命名为 save_key。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key">参考文档</a></p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="scope-instance_method">
  
    #<strong>scope</strong>  &#x21d2; <tt>String</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns 上传目标范围</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传目标范围</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 57</span>

<span class='kw'>class</span> <span class='const'><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">UploadPolicy</a></span></span>
  <span class='comment'># 上传策略解析错误
</span>  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="UploadPolicy/Errors.html" title="QiniuNg::Storage::Model::UploadPolicy::Errors (module)">Errors</a></span></span>
    <span class='comment'># 上传凭证不合法，无法从中解析出上传策略
</span>    <span class='kw'>class</span> <span class='const'>InvalidUploadToken</span> <span class='op'>&lt;</span> <span class='const'>ArgumentError</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:scope</span><span class='comma'>,</span> <span class='symbol'>:bucket</span><span class='comma'>,</span> <span class='symbol'>:key</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:return_url</span><span class='comma'>,</span> <span class='symbol'>:return_body</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:callback_urls</span><span class='comma'>,</span> <span class='symbol'>:callback_host</span><span class='comma'>,</span> <span class='symbol'>:callback_body</span><span class='comma'>,</span> <span class='symbol'>:callback_body_type</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:persistent_ops</span><span class='comma'>,</span> <span class='symbol'>:persistent_notify_url</span><span class='comma'>,</span> <span class='symbol'>:persistent_pipeline</span>
  <span class='id identifier rubyid_attr_accessor'>attr_accessor</span> <span class='symbol'>:end_user</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:min_file_size</span><span class='comma'>,</span> <span class='symbol'>:max_file_size</span>
  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:save_key</span><span class='comma'>,</span> <span class='symbol'>:force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>bucket:</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket'>bucket</span>
    <span class='ivar'>@key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>||</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span>
    <span class='ivar'>@scope</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Entry.html" title="QiniuNg::Storage::Model::Entry (class)">Entry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='ivar'>@bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='ivar'>@key</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'><span class='object_link'><a href="Entry.html#to_s-instance_method" title="QiniuNg::Storage::Model::Entry#to_s (method)">to_s</a></span></span>
    <span class='ivar'>@is_prefixal_scope</span> <span class='op'>=</span> <span class='id identifier rubyid_key_prefix'>key_prefix</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='kw'>true</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@end_user</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_upload_token_lifetime'><span class='object_link'><a href="../../Config.html#default_upload_token_lifetime-class_method" title="QiniuNg::Config.default_upload_token_lifetime (method)">default_upload_token_lifetime</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] lifetime 上传凭证有效期，单位为秒
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># @example
</span>  <span class='comment'>#   token = entry.upload_token do |policy|
</span>  <span class='comment'>#             policy.set_token_lifetime(day: 1) }
</span>  <span class='comment'>#           end
</span>  <span class='comment'>#   entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer, Hash, QiniuNg::Duration] args 上传凭证有效期，可以用 Hash 表示
</span>  <span class='comment'>#   参数细节可以参考 QiniuNg::Utils::Duration#initialize
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>
  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 上传凭证有效期
</span>  <span class='comment'>#
</span>  <span class='comment'># 注意，上传策略中其实只存储了上传凭证的过期时间。
</span>  <span class='comment'># 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。
</span>  <span class='comment'># 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度，
</span>  <span class='comment'># 因为该结果是由上传凭证中的过期时间减去当前时间得到的。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Duration, nil] 返回有效期长度，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Time] deadline 上传凭证过期时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
    <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传凭证过期时间
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Time] 返回过期时间，如果为 nil 表示从未设置过有效期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
    <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 判断 #key 表示的是文件名前缀还是文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] #key 是否表示文件名前缀
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
    <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否仅能以新增模式上传文件
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
    <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否自动侦测上传文件的 MIME 类型？
</span>  <span class='comment'># 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'># 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否自动侦测上传文件的 MIME 类型
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
    <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用标准存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
    <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>end</span>

  <span class='comment'># 是否使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [Boolean] 是否使用低频存储
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
    <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>end</span>

  <span class='comment'># 仅能以新增模式上传文件
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
    <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
    <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用标准存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 使用低频存储
</span>  <span class='comment'>#
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 要求 Web 端文件上传成功后，浏览器执行 303 跳转
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] url 浏览器执行 303 跳转时的 URL
</span>  <span class='comment'># @param [String] body 上传成功后，自定义七牛云最终返回给上传端的数据
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
    <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后，将回调业务服务器。
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] urls 回调业务服务器的 URL 列表
</span>  <span class='comment'># @param [String] host 回调 HOST
</span>  <span class='comment'># @param [String] body 回调请求的内容
</span>  <span class='comment'># @param [String] body_type 回调请求的内容类型，默认为 application/x-www-form-urlencoded
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
    <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
    <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
    <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 上传成功后触发执行的预转持久化处理
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] ops 预转持久化处理指令列表
</span>  <span class='comment'># @param [String] notify_url 预转持久化处理完毕后回调业务服务器的 URL
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] pipeline 转码队列名
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
    <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
    <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的大小范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [Integer] max 限定上传文件大小最大值，单位为字节
</span>  <span class='comment'># @param [Integer] min 限定上传文件大小最小值，单位为字节
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
    <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 限定上传文件的 MIME 类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String, Array&lt;String&gt;] content_type 限制上传文件类型范围
</span>  <span class='comment'>#
</span>  <span class='comment'># @see https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit
</span>  <span class='comment'># @return [QiniuNg::Storage::Model::UploadPolicy] 返回上下文
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
    <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># 获取上传文件的 MIME 类型限定范围
</span>  <span class='comment'># @return [Array&lt;String&gt;] 限制的上传文件类型范围
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
    <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:disable Naming/AccessorMethodName
</span>
  <span class='comment'># 设置上传文件的生命周期
</span>  <span class='comment'># @param [String] days 指定被删除的时间
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
    <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
    <span class='kw'>self</span>
  <span class='kw'>end</span>

  <span class='comment'># rubocop:enable Naming/AccessorMethodName
</span>
  <span class='comment'># 获取上传文件的生命周期
</span>  <span class='comment'># @return [QiniuNg::Duration] 上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
    <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>end</span>

  <span class='comment'># 设置上传文件的文件名
</span>  <span class='comment'>#
</span>  <span class='comment'># @param [String] key 自定义文件名。
</span>  <span class='comment'>#   如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key，
</span>  <span class='comment'>#   而当 force 为 true 时，将强制将文件命名为 key。
</span>  <span class='comment'>#   {参考文档}[https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key]
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
    <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_force_save_key?'>force_save_key?</span> <span class='id identifier rubyid_force_save_key'>force_save_key</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_from_json'>from_json</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_hash'>hash</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_unmarshaler'><span class='object_link'><a href="../../Config.html#default_json_unmarshaler-class_method" title="QiniuNg::Config.default_json_unmarshaler (method)">default_json_unmarshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_json'>json</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>scope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>isPrefixalScope</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key_prefix:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>else</span>
               <span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>bucket:</span> <span class='id identifier rubyid_bucket'>bucket</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span>
             <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>saveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>forceSaveKey</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_insert_only!'>insert_only!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>insertOnly</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_detect_mime!'>detect_mime!</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>detectMime</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>1</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='comma'>,</span> <span class='kw'>nil</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
    <span class='kw'>when</span> <span class='const'><span class='object_link'><a href="../Model.html" title="QiniuNg::Storage::Model (module)">Model</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
      <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>InvalidUploadToken</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unrecognized fileType: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fileType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_token_deadline'>token_deadline</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deadline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_end_user'>end_user</span> <span class='op'>=</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>endUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_policy'>policy</span><span class='period'>.</span><span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>returnBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                        <span class='label'>host:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackHost</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBody</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                        <span class='label'>body_type:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>callbackBodyType</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentOps</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='op'>&amp;.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
                              <span class='label'>notify_url:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentNotifyUrl</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                              <span class='label'>pipeline:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>persistentPipeline</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>min:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeMin</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>max:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fsizeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mimeLimit</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='period'>.</span><span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span> <span class='id identifier rubyid_hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>deleteAfterDays</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_h'>to_h</span>
    <span class='id identifier rubyid_h'>h</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>scope:</span> <span class='ivar'>@scope</span><span class='comma'>,</span>
      <span class='label'>isPrefixalScope:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@is_prefixal_scope</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>insertOnly:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@insert_only</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>detectMime:</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'>Bool</span><span class='period'>.</span><span class='id identifier rubyid_to_int'>to_int</span><span class='lparen'>(</span><span class='ivar'>@detect_mime</span><span class='comma'>,</span> <span class='label'>omitempty:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>endUser:</span> <span class='ivar'>@end_user</span><span class='comma'>,</span>
      <span class='label'>returnUrl:</span> <span class='ivar'>@return_url</span><span class='comma'>,</span>
      <span class='label'>returnBody:</span> <span class='ivar'>@return_body</span><span class='comma'>,</span>
      <span class='label'>callbackUrl:</span> <span class='ivar'>@callback_urls</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>callbackHost:</span> <span class='ivar'>@callback_host</span><span class='comma'>,</span>
      <span class='label'>callbackBody:</span> <span class='ivar'>@callback_body</span><span class='comma'>,</span>
      <span class='label'>callbackBodyType:</span> <span class='ivar'>@callback_body_type</span><span class='comma'>,</span>
      <span class='label'>persistentOps:</span> <span class='ivar'>@persistent_ops</span><span class='op'>&amp;.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>persistentNotifyUrl:</span> <span class='ivar'>@persistent_notify_url</span><span class='comma'>,</span>
      <span class='label'>persistentPipeline:</span> <span class='ivar'>@persistent_pipeline</span><span class='comma'>,</span>
      <span class='label'>saveKey:</span> <span class='ivar'>@save_key</span><span class='comma'>,</span>
      <span class='label'>forceSaveKey:</span> <span class='ivar'>@force_save_key</span><span class='comma'>,</span>
      <span class='label'>fsizeMin:</span> <span class='ivar'>@min_file_size</span><span class='comma'>,</span>
      <span class='label'>fsizeLimit:</span> <span class='ivar'>@max_file_size</span><span class='comma'>,</span>
      <span class='label'>mimeLimit:</span> <span class='ivar'>@mime_limit</span><span class='comma'>,</span>
      <span class='label'>deadline:</span> <span class='ivar'>@deadline</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>deleteAfterDays:</span> <span class='ivar'>@delete_after_days</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
      <span class='label'>fileType:</span> <span class='ivar'>@file_type</span><span class='op'>&amp;.</span><span class='id identifier rubyid_to_i'>to_i</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_h'>h</span><span class='period'>.</span><span class='id identifier rubyid_each_with_object'>each_with_object</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='lparen'>(</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='rparen'>)</span><span class='comma'>,</span> <span class='id identifier rubyid_o'>o</span><span class='op'>|</span>
      <span class='id identifier rubyid_o'>o</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_v'>v</span> <span class='kw'>unless</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>alias</span> <span class='id identifier rubyid_as_json'>as_json</span> <span class='id identifier rubyid_to_h'>to_h</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='op'>==</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_to_h'>to_h</span> <span class='op'>==</span> <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span>
  <span class='kw'>end</span>

  <span class='comment'># @!visibility private
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_to_json'>to_json</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Config.html" title="QiniuNg::Config (class)">Config</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default_json_marshaler'><span class='object_link'><a href="../../Config.html#default_json_marshaler-class_method" title="QiniuNg::Config.default_json_marshaler (method)">default_json_marshaler</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_as_json'>as_json</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="content_type_limit-instance_method">
  
    #<strong>content_type_limit</strong>  &#x21d2; <tt>Array&lt;String&gt;</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>获取上传文件的 MIME 类型限定范围</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限制的上传文件类型范围</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


295
296
297</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 295</span>

<span class='kw'>def</span> <span class='id identifier rubyid_content_type_limit'>content_type_limit</span>
  <span class='ivar'>@mime_limit</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="detect_mime!-instance_method">
  
    #<strong>detect_mime!</strong>  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>自动侦测上传文件的 MIME 类型，忽略用户在上传时传入的 MIME 类型参数。</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


202
203
204
205</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 202</span>

<span class='kw'>def</span> <span class='id identifier rubyid_detect_mime!'>detect_mime!</span>
  <span class='ivar'>@detect_mime</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="detect_mime?-instance_method">
  
    #<strong>detect_mime?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>是否自动侦测上传文件的 MIME 类型？ 如果为 true，表示自动侦测，并忽略用户在上传时传入的 MIME 类型参数。 否则，只在当用户上传文件时没有传入的 MIME 类型参数时，才会自动侦测。</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>是否自动侦测上传文件的 MIME 类型</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


173
174
175</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 173</span>

<span class='kw'>def</span> <span class='id identifier rubyid_detect_mime?'>detect_mime?</span>
  <span class='op'>!</span><span class='ivar'>@detect_mime</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="file_lifetime-instance_method">
  
    #<strong>file_lifetime</strong>  &#x21d2; <tt><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">QiniuNg::Duration</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>获取上传文件的生命周期</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">QiniuNg::Duration</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传文件的生命周期，如果为 nil 表示从未设置过文件的生命周期</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


312
313
314</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 312</span>

<span class='kw'>def</span> <span class='id identifier rubyid_file_lifetime'>file_lifetime</span>
  <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>day:</span> <span class='ivar'>@delete_after_days</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@delete_after_days</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="infrequent_storage!-instance_method">
  
    #<strong>infrequent_storage!</strong>  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>使用低频存储</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


218
219
220
221</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 218</span>

<span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage!'>infrequent_storage!</span>
  <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="infrequent_storage?-instance_method">
  
    #<strong>infrequent_storage?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>是否使用低频存储</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>是否使用低频存储</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


187
188
189</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 187</span>

<span class='kw'>def</span> <span class='id identifier rubyid_infrequent_storage?'>infrequent_storage?</span>
  <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_infrequent'>infrequent</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="insert_only!-instance_method">
  
    #<strong>insert_only!</strong>  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>仅能以新增模式上传文件</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 194</span>

<span class='kw'>def</span> <span class='id identifier rubyid_insert_only!'>insert_only!</span>
  <span class='ivar'>@insert_only</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="insert_only?-instance_method">
  
    #<strong>insert_only?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>是否仅能以新增模式上传文件</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>是否仅能以新增模式上传文件</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


164
165
166</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 164</span>

<span class='kw'>def</span> <span class='id identifier rubyid_insert_only?'>insert_only?</span>
  <span class='op'>!</span><span class='ivar'>@insert_only</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="limit_content_type-instance_method">
  
    #<strong>limit_content_type</strong>(content_type)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>限定上传文件的 MIME 类型范围</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>content_type</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限制上传文件类型范围</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit">https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-mime-limit</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


287
288
289
290
291</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 287</span>

<span class='kw'>def</span> <span class='id identifier rubyid_limit_content_type'>limit_content_type</span><span class='lparen'>(</span><span class='id identifier rubyid_content_type'>content_type</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_content_type'>content_type</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_content_type'>content_type</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span>
  <span class='ivar'>@mime_limit</span> <span class='op'>=</span> <span class='id identifier rubyid_content_type'>content_type</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="limit_file_size-instance_method">
  
    #<strong>limit_file_size</strong>(max: nil, min: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>限定上传文件的大小范围</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>max</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限定上传文件大小最大值，单位为字节</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>min</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>限定上传文件大小最小值，单位为字节</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min">https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-fsize-min</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


275
276
277
278
279</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 275</span>

<span class='kw'>def</span> <span class='id identifier rubyid_limit_file_size'>limit_file_size</span><span class='lparen'>(</span><span class='label'>max:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>min:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@min_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_min'>min</span>
  <span class='ivar'>@max_file_size</span> <span class='op'>=</span> <span class='id identifier rubyid_max'>max</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="normal_storage!-instance_method">
  
    #<strong>normal_storage!</strong>  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>使用标准存储</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210
211
212
213</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 210</span>

<span class='kw'>def</span> <span class='id identifier rubyid_normal_storage!'>normal_storage!</span>
  <span class='ivar'>@file_type</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="normal_storage?-instance_method">
  
    #<strong>normal_storage?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>是否使用标准存储</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>是否使用标准存储</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 180</span>

<span class='kw'>def</span> <span class='id identifier rubyid_normal_storage?'>normal_storage?</span>
  <span class='ivar'>@file_type</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>||</span> <span class='ivar'>@file_type</span> <span class='op'>==</span> <span class='const'><span class='object_link'><a href="StorageType.html" title="QiniuNg::Storage::Model::StorageType (class)">StorageType</a></span></span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="prefixal_scope?-instance_method">
  
    #<strong>prefixal_scope?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>判断 #key 表示的是文件名前缀还是文件名</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>#key 是否表示文件名前缀</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


157
158
159</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 157</span>

<span class='kw'>def</span> <span class='id identifier rubyid_prefixal_scope?'>prefixal_scope?</span>
  <span class='op'>!</span><span class='ivar'>@is_prefixal_scope</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="save_as-instance_method">
  
    #<strong>save_as</strong>(key, force: false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传文件的文件名</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>key</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>自定义文件名。 如果传入的 force 为 false 时，当用户上传的时候没有主动指定 key 时才会使用 key， 而当 force 为 true 时，将强制将文件命名为 key。 <a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#save-key">参考文档</a></p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


322
323
324
325</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 322</span>

<span class='kw'>def</span> <span class='id identifier rubyid_save_as'>save_as</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='label'>force:</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='ivar'>@save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
  <span class='ivar'>@force_save_key</span> <span class='op'>=</span> <span class='id identifier rubyid_force'>force</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_callback-instance_method">
  
    #<strong>set_callback</strong>(urls, host: nil, body: nil, body_type: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>上传成功后，将回调业务服务器。</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>urls</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>回调业务服务器的 URL 列表</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>host</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>回调 HOST</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>回调请求的内容</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body_type</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>回调请求的内容类型，默认为 application/x-www-form-urlencoded</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url">https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-callback-url</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


245
246
247
248
249
250
251</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 245</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_callback'>set_callback</span><span class='lparen'>(</span><span class='id identifier rubyid_urls'>urls</span><span class='comma'>,</span> <span class='label'>host:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body_type:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@callback_urls</span> <span class='op'>=</span> <span class='id identifier rubyid_urls'>urls</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_urls'>urls</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_urls'>urls</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_urls'>urls</span>
  <span class='ivar'>@callback_host</span> <span class='op'>=</span> <span class='id identifier rubyid_host'>host</span>
  <span class='ivar'>@callback_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
  <span class='ivar'>@callback_body_type</span> <span class='op'>=</span> <span class='id identifier rubyid_body_type'>body_type</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_file_lifetime-instance_method">
  
    #<strong>set_file_lifetime</strong>(days:)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传文件的生命周期</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>days</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>指定被删除的时间</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


303
304
305
306</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 303</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_file_lifetime'>set_file_lifetime</span><span class='lparen'>(</span><span class='label'>days:</span><span class='rparen'>)</span>
  <span class='ivar'>@delete_after_days</span> <span class='op'>=</span> <span class='id identifier rubyid_days'>days</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_persistent_ops-instance_method">
  
    #<strong>set_persistent_ops</strong>(ops, notify_url: nil, pipeline: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>上传成功后触发执行的预转持久化处理</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>ops</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>预转持久化处理指令列表</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>notify_url</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>预转持久化处理完毕后回调业务服务器的 URL</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>pipeline</span>
      
      
        <span class='type'>(<tt>String</tt>, <tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>转码队列名</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops">https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-persistent-ops</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


261
262
263
264
265
266</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 261</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_persistent_ops'>set_persistent_ops</span><span class='lparen'>(</span><span class='id identifier rubyid_ops'>ops</span><span class='comma'>,</span> <span class='label'>notify_url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>pipeline:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@persistent_ops</span> <span class='op'>=</span> <span class='id identifier rubyid_ops'>ops</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_ops'>ops</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='id identifier rubyid_ops'>ops</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_ops'>ops</span>
  <span class='ivar'>@persistent_notify_url</span> <span class='op'>=</span> <span class='id identifier rubyid_notify_url'>notify_url</span>
  <span class='ivar'>@persistent_pipeline</span> <span class='op'>=</span> <span class='id identifier rubyid_pipeline'>pipeline</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_return-instance_method">
  
    #<strong>set_return</strong>(url: nil, body: nil)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>要求 Web 端文件上传成功后，浏览器执行 303 跳转</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>url</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>浏览器执行 303 跳转时的 URL</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>body</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传成功后，自定义七牛云最终返回给上传端的数据</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url" target="_parent" title="https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url">https://developer.qiniu.com/kodo/manual/1206/put-policy#put-policy-return-url</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


230
231
232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 230</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_return'>set_return</span><span class='lparen'>(</span><span class='label'>url:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>body:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='ivar'>@return_url</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
  <span class='ivar'>@return_body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_token_lifetime-instance_method">
  
    #<strong>set_token_lifetime</strong>(*args)  &#x21d2; <tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传凭证有效期</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>token = entry.upload_token do |policy|
          policy.set_token_lifetime(day: 1) }
        end
entry.bucket.upload(filepath: &#39;/path/to/file&#39;, upload_token: token)</code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>args</span>
      
      
        <span class='type'>(<tt>Integer</tt>, <tt>Hash</tt>, <tt><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">QiniuNg::Duration</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传凭证有效期，可以用 Hash 表示 参数细节可以参考 QiniuNg::Utils::Duration#initialize</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="QiniuNg::Storage::Model::UploadPolicy (class)">QiniuNg::Storage::Model::UploadPolicy</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回上下文</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


122
123
124
125</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 122</span>

<span class='kw'>def</span> <span class='id identifier rubyid_set_token_lifetime'>set_token_lifetime</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_token_lifetime'>token_lifetime</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='kw'>self</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="token_deadline-instance_method">
  
    #<strong>token_deadline</strong>  &#x21d2; <tt>Time</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传凭证过期时间</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Time</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回过期时间，如果为 nil 表示从未设置过有效期</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 150</span>

<span class='kw'>def</span> <span class='id identifier rubyid_token_deadline'>token_deadline</span>
  <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="token_deadline=-instance_method">
  
    #<strong>token_deadline=</strong>(deadline)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传凭证过期时间</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>deadline</span>
      
      
        <span class='type'>(<tt>Time</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传凭证过期时间</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


143
144
145</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 143</span>

<span class='kw'>def</span> <span class='id identifier rubyid_token_deadline='>token_deadline=</span><span class='lparen'>(</span><span class='id identifier rubyid_deadline'>deadline</span><span class='rparen'>)</span>
  <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_deadline'>deadline</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="token_lifetime-instance_method">
  
    #<strong>token_lifetime</strong>  &#x21d2; <tt><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">QiniuNg::Duration</a></span></tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>上传凭证有效期</p>

<p>注意，上传策略中其实只存储了上传凭证的过期时间。 如果调用 #token_lifetime= 或 #set_token_lifetime，SDK 将会自动计算出过期时间并设置在上传凭证上。 此时，如果再调用 #token_lifetime，得到的结果几乎总是小于先前设置的有效期长度， 因为该结果是由上传凭证中的过期时间减去当前时间得到的。</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">QiniuNg::Duration</a></span></tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>返回有效期长度，如果为 nil 表示从未设置过有效期</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 136</span>

<span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime'>token_lifetime</span>
  <span class='const'><span class='object_link'><a href="../../Utils.html" title="QiniuNg::Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Utils/Duration.html" title="QiniuNg::Utils::Duration (class)">Duration</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../Utils/Duration.html#initialize-instance_method" title="QiniuNg::Utils::Duration#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>seconds:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_at'>at</span><span class='lparen'>(</span><span class='ivar'>@deadline</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@deadline</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="token_lifetime=-instance_method">
  
    #<strong>token_lifetime=</strong>(lifetime)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>设置上传凭证有效期</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>lifetime</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>上传凭证有效期，单位为秒</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


105
106
107</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/qiniu_ng/storage/model/upload_policy.rb', line 105</span>

<span class='kw'>def</span> <span class='id identifier rubyid_token_lifetime='>token_lifetime=</span><span class='lparen'>(</span><span class='id identifier rubyid_lifetime'>lifetime</span><span class='rparen'>)</span>
  <span class='ivar'>@deadline</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='id identifier rubyid_lifetime'>lifetime</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='lparen'>(</span><span class='int'>1</span> <span class='op'>&lt;&lt;</span> <span class='int'>32</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_min'>min</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Thu Aug  1 18:48:50 2019 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.20 (ruby-2.6.1).
</div>

    </div>
  </body>
</html>